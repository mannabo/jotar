name: Deploy JOTAR to jotarjohor.com

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to jotarjohor.com via SSH
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Get latest code
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ Display files to deploy
      run: |
        echo "Files that will be deployed:"
        find . -type f \
          ! -path './.git/*' \
          ! -path './.github/*' \
          ! -name '*.md' \
          ! -name '*.txt' \
          ! -name '*.tar.gz' \
          ! -name 'deploy.sh' \
          | head -20
    
    - name: ğŸ” Setup SSH with password
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
    
    - name: ğŸ§¹ Prepare deployment directory
      run: |
        sshpass -p '${{ secrets.HOSTINGER_PASSWORD }}' ssh -p 65002 -o StrictHostKeyChecking=no u359923617@151.106.117.45 "
          # Create jotarjohor.com specific directory if doesn't exist
          mkdir -p ~/domains/jotarjohor.com/public_html
          cd ~/domains/jotarjohor.com/public_html
          
          # Create backup if files exist
          if [ \"\$(ls -A . 2>/dev/null)\" ]; then
            mkdir -p ~/backups/jotarjohor_backup_\$(date +%Y%m%d_%H%M%S)
            cp -r . ~/backups/jotarjohor_backup_\$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
            
            # Clean directory (keep .htaccess if exists)
            find . -name '.htaccess' -prune -o -type f -exec rm {} + 2>/dev/null || true
            find . -type d -empty -delete 2>/dev/null || true
          fi
        "
    
    - name: ğŸ“¤ Deploy via rsync over SSH
      run: |
        sshpass -p '${{ secrets.HOSTINGER_PASSWORD }}' rsync -avz --delete -e "ssh -p 65002 -o StrictHostKeyChecking=no" \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='*.md' \
          --exclude='*.txt' \
          --exclude='*.tar.gz' \
          --exclude='deploy.sh' \
          --exclude='.DS_Store' \
          --exclude='Thumbs.db' \
          --exclude='*.log' \
          --exclude='*_key*' \
          ./ u359923617@151.106.117.45:domains/jotarjohor.com/public_html/
    
    - name: ğŸ”§ Set correct permissions
      run: |
        sshpass -p '${{ secrets.HOSTINGER_PASSWORD }}' ssh -p 65002 -o StrictHostKeyChecking=no u359923617@151.106.117.45 "
          cd ~/domains/jotarjohor.com/public_html
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          chmod 644 *.html *.css *.js 2>/dev/null || true
        "
    
    - name: âœ… Deployment complete
      run: |
        echo "ğŸ‰ JOTAR website deployed successfully!"
        echo "ğŸŒ Main site: https://jotarjohor.com"
        echo "ğŸ” Admin panel: https://jotarjohor.com/admin/"
        echo "ğŸ“š Course page: https://jotarjohor.com/landingpages-kursus/"