name: Deploy JOTAR to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to Hostinger via SSH
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Get latest code
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ Display files to deploy
      run: |
        echo "Files that will be deployed:"
        find . -type f \
          ! -path './.git/*' \
          ! -path './.github/*' \
          ! -name '*.md' \
          ! -name '*.txt' \
          ! -name '*.tar.gz' \
          ! -name 'deploy.sh' \
          | head -20
    
    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}
    
    - name: ğŸ§¹ Prepare deployment directory
      run: |
        ssh -p ${{ secrets.HOSTINGER_PORT }} -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} "
          # Create public_html if doesn't exist
          mkdir -p domains/${{ secrets.DOMAIN_NAME }}/public_html
          cd domains/${{ secrets.DOMAIN_NAME }}/public_html
          
          # Create backup if files exist
          if [ \"$(ls -A .)\" ]; then
            mkdir -p ../../backups/backup_$(date +%Y%m%d_%H%M%S)
            cp -r . ../../backups/backup_$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
            
            # Clean directory (keep .htaccess if exists)
            find . -name '.htaccess' -prune -o -type f -exec rm {} + 2>/dev/null || true
            find . -type d -empty -delete 2>/dev/null || true
          fi
        "
    
    - name: ğŸ“¤ Deploy via rsync over SSH
      run: |
        rsync -avz --delete -e "ssh -p ${{ secrets.HOSTINGER_PORT }}" \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='*.md' \
          --exclude='*.txt' \
          --exclude='*.tar.gz' \
          --exclude='deploy.sh' \
          --exclude='.DS_Store' \
          --exclude='Thumbs.db' \
          --exclude='*.log' \
          ./ ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:domains/${{ secrets.DOMAIN_NAME }}/public_html/
    
    - name: ğŸ”§ Set correct permissions
      run: |
        ssh -p ${{ secrets.HOSTINGER_PORT }} -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} "
          cd domains/${{ secrets.DOMAIN_NAME }}/public_html
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          chmod 644 *.html *.css *.js 2>/dev/null || true
        "
    
    - name: âœ… Deployment complete
      run: |
        echo "ğŸ‰ JOTAR website deployed successfully!"
        echo "ğŸŒ Main site: https://${{ secrets.DOMAIN_NAME }}"
        echo "ğŸ” Admin panel: https://${{ secrets.DOMAIN_NAME }}/admin/"
        echo "ğŸ“š Course page: https://${{ secrets.DOMAIN_NAME }}/landingpages-kursus/"